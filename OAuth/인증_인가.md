`GraphQL rhk 타입스크립트로 개발하는 웹 서비스` 책 내용중

사용자가 누구인지 확인하는 과정을 인증(Authentication) 이라고 부릅니다.  
그리고 사용자가 어떤 권한을 가지고 있는지 확인하거나 허가하는 과정을 인가(Authorization)라고 부릅니다.

인증과 인가를 구현할 수 있는 방법은 여러 가지가 있습니다.  
대표적을 인증의 경우 임시적으로 발급한 토큰을 활용하거나 세션을 활용하는 경우가 많고,  
인가의 경우 RBAC(Role Based Access Control, 역할 기반 엑세스 제어)와 ABAC(Attribute Based Access Control, 속성 기반 엑세스 제어) 방식 등이 사용됩니다.

HTTP 상에서 동작하는 웹 서비스에서 사용자 식별 즉, '인증'을 구현하는 방법은 크게 두 가지로 나누어 이해할 수 있습니다.  
두 가지 방법은 세션 기반 인증과 토큰 기반 인증 입니다.  
두 방식은 모두 HTTP 의 특징인 무상태성(stateless)과 필요한 작업이 끝나면 연결을 끊는 비연결적이라는 특징을 반영한 인증 방식입니다.

## 세션 기반 인증

세션 기반 인증은 다음과 같은 과정으로 진행됩니다.

서버는 아이디/비밀번호와 같이 유저를 확인할 수 있는 정보를 활용하여 유저에 대한 식별을 끝낸 뒤,  
식별된 유저의 정보를 담는 세션을 생성합니다.  
이때 생성한 세션의 ID 를 세션 저장소(메모리 또는 데이터 베이스)에 저장합니다.  
생성된 세션 ID 를 브라우저의 쿠키에 저장되도록 하는 Set-Cookie 헤더를 포함한 응답을 보내,  
브라우저상에 해당 세션 ID 가 저장될 수 있도록 합니다.

이렇게 세션 ID 가 브라우저상에 세션 쿠키의 형태로 저장된 이후에는 해당 브라우저로 부터의 요청은 항상 세션 ID 가 담긴 쿠키가 함꼐 전송됩니다.  
서버는 요청에 포함되어 전송된 세션 ID 를, 세션 저장소에서 저장되어 있는 세션 ID 와 비교하여 해당 요청이 올바르게 로그인된 유저로 부터의 요청인지를 파악한뒤, 요청된 작업을 처리합니다.

서버가 모든 인증을 다루므로, 다루어야 할 사용자의 양이 많은 경우 발생하는 모든 과부하를 감당하여야 합니다.  
이러한 단일 인증 체계의 특성은 모놀리식(Monolithic) 아키텍처의 특성과 비슷해 보입니다.  
즉, 모놀리식 아키텍처가 가진 장점과 단점을 동일하게 가지고 있습니다.  
즉, 비교적 확장성이 떨어지며, 서버 자원의 자동 확장(Aoto Scaling 과 같은)을 구현 또는 활용하기 어려워 유연하지 못합니다.  
그리고 마이크로 서비스 아키텍처로 운영되는 서비스에서 세션을 통해 인증을 처리하는 경우, 많은 클라이언트로 부터의 인증을 하나의 서버에서 모두 다루게 되므로 관리의 어려움이 불가피합니다.

## 토큰 기반 인증

요즘, 웹 서비스에서의 토큰 기반 인증은 대개 JWT(JSON Web Token)를 활용하는 방식으로 구현됩니다.  
JWT 는 자바스크립트 진영에서 활발히 활용되는 JSON 데이터를 활용합니다. JWT 는 JSON 정보를 디지털 서명을 포함한 토큰으로 구성하며,  
간결하면서도 정보에 대한 무결성을 보장하고, 안전하게 전송 할 수 있도록 합니다.

JWT 토큰 기반 인증은 다음과 같은 과정으로 진행됩니다.

서버는 아이디/비밀번호와 같이 유저를 확인할 수 있는 정보를 활용하여 유저에 대한 식별을 끝낸 뒤,  
식별된 유저의 정보와 서버로부터 생성된 서명과 토큰 만료 시간 등, 인증에 대한 정보를 담는 JWT 토큰을 생성합니다.  
이후, JWT를 브라우저로 곧바로 전송합니다. 토큰을 전송받은 브라우저에서는 해당 JWT 토큰을 자기만의 방식으로 저장합니다.  
대개 브라우저 저장소인 local storage 또는 쿠키를 사용합니다.

이후, 브라우저에서 서버로 요청할 때에는 언제나 저장된 JWT 토큰을 함께 전송하도록 구성합니다.  
전송 시에는 Authorization 헤더에 토큰을 전송하는 방식이 주로 사용됩니다.  
서버에서는 헤더에 담겨 전송된 JWT 토큰을 유효성 검사하여 유저를 식별한 뒤, 요청된 작업을 처리합니다.

앞서 설명한 토큰 기반 인증에 대한 내용은 가장 기본적인 구조를 설명한 것입니다.  
이 기본적인 구조에서는 토큰의 탈취를 통한 XSS(Cross-Site Scription), CSRF(Cross-Site Request Forgery) 공격에 취약하므로, 더 복잡한 구조를 구성할 수 있습니다.

세션 기반 인증에 비해 구현이 조금 더 복잡하고, 한번 발급된 토큰은 폐기가 불가능한 특징 등 몇 가지 제약사항이 있습니다.  
또한 토큰 탈취 등 보안 위협이 존재하고, 이 보안 위협을 해결하기 위해 추가적 구성을 진행하게 되는 경우, 두 가지 이상의 토큰을 다루거나 세션과 동일하게 서버상에 JWT 토큰 또는 유저 인정 정보를 저장하고  
저장된 토큰을 비교하는 절차가 추가되는 등 토큰 기반 인증의 장점을 잃게 되는 경우가 발생합니다.

## 세션 VS 토큰

세션 기반 인증과 토큰 기반 인증은 어떤 것이 더 우월하다고 규정할 수 없습니다.  
언제나 완벽한 기술은 없으며 상황에 따라 더 잘 어울리는 방식을 사용하는 것이 바람직할 뿐입니다.
