# 이벤트루프 (Event Loop, 자바스크립트 엔진)

https://velog.io/@zinukk/d-krgvcbsc

이벤트 루프(Event Loop)는 JavaScript에서 비동기 작업을 처리하고 이벤트를 관리하는 메커니즘

이벤트 루프는 Stack이 비어 있을 때 Queue에서 가장 오래된 작업을 가져와 Stack에 넣어준다.

- CallStack이 비어있는지 확인
- Queue에 할 일이 있는지 확인
- CallStack 비어있으면 일감을 Queue -> CallStack으로 이동

## 태스크큐 vs 마이크로태스크큐

Event Loop 는 두 가지 종류의 작업 큐, 즉 "태스크 큐(task queue)"와 "마이크로태스크 큐(microtask queue)"를 갖고 있다.  
두 큐 모두 비동기 작업이 완료될 때까지 그 작업을 대기시키는 역할을 하지만, 두 큐는 처리 방식과 우선순위에 있어서 몇 가지 차이점이 있다.

## 태스크큐

태스크 큐는 "매크로태스크(macrotasks)"를 관리합니다.  
타이머(setTimeout, setInterval), UI 이벤트, 네트워크 이벤트(fetch의 완료) 등이 이에 해당한다.

이벤트 루프는 태스크 큐에서 가장 오래된 태스크를 하나씩 꺼내어 실행하며,  
각 매크로태스크 사이에는 브라우저의 렌더링 작업이 들어갈 수 있다.

## 마이크로태스크큐

반면에 마이크로태스크 큐는 "마이크로태스크(microtasks)"를 관리한다.

프로미스의 then 콜백, MutationObserver 콜백 등이 이에 해당한다.

이벤트 루프는 현재 실행 중인 매크로태스크가 완료되면 마이크로태스크 큐를 확인하고, 큐에 있는 모든 마이크로태스크를 한 번에 실행한다.

이 때 중요한 점은, `마이크로태스크 큐가 비워질 때까지 모든 마이크로태스크를 실행하며, 이 과정 사이에는 브라우저의 렌더링이 발생하지 않는다는 점이다!`

## 차이점

따라서 `가장 큰 차이점은 "우선순위"다.`

마이크로태스크는 매크로태스크보다 더 높은 우선순위를 갖는다.

즉, 매크로태스크가 완료되면 이벤트 루프는 먼저 마이크로태스크 큐를 확인하고, 마이크로태스크 큐가 비워질 때까지 모든 마이크로태스크를 실행한다.

그리고 나서야 다음 매크로태스크를 처리하는데 이를 통해 더 빠른 반응성을 제공할 수 있는 작업(예: 프로미스의 then 콜백)은 가능한 한 빨리 처리되고,  
시간이 많이 소요되는 작업(예: 타이머 콜백, UI 이벤트)은 그 사이에 끼어들지 못하게 된다.

또한 `렌더링과의 관계에서도 차이점이 있다.`

매크로태스크 사이에는 브라우저의 렌더링 작업이 들어갈 수 있지만,  
마이크로태스크를 처리하는 동안에는 렌더링이 발생하지 않는다.

이는 마이크로태스크가 UI를 업데이트하는 등의 작업을 한 번에 모아서 처리할 수 있게 하여,  
불필요한 렌더링을 방지하고 효율성을 높인다.

## 요약

- 태스크 큐는 매크로태스크를 관리하며, 이벤트 루프는 태스크 큐에서 가장 오래된 태스크를 하나씩 꺼내어 실행한다.
- 마이크로태스크 큐는 마이크로태스크를 관리하며, 매크로태스크가 완료되면 이벤트 루프는 마이크로태스크 큐에 있는 모든 작업을 한 번에 실행한다.
- 마이크로태스크는 태스크보다 더 높은 우선순위를 갖는다.
- 마이크로태스크를 처리하는 동안에는 브라우저의 렌더링이 발생하지 않는다.

---

# queueMicrotask

https://developer.mozilla.org/ko/docs/Web/API/HTML_DOM_API/Microtask_guide

마이크로태스크는 현대 브라우저 기반 JavaScript 개발에서 고도로 특화된 기능으로서,  
사용자 컴퓨터에서 발생할 수많은 것들의 앞에서 `다른 것보다 우선해서 실행할 코드를 예약할 수 있는 기능`입니다.  
`이 능력을 남용하면 성능 문제에 빠질 것`입니다.

따라서, 마이크로태스크의 사용은 다른 해결책이 전혀 없거나,  
프레임워크 또는 라이브러리에서 구현하고자 하는 기능에 필요한 경우에만 사용해야 합니다.  
과거에도 마이크로태스크를 큐에 추가하는 우회 방법이 (즉시 이행하는 프로미스 생성처럼) 없지는 않았으나,  
`queueMicrotask() 메서드의 추가 덕분에 마이크로태스크를 안전하고 우회 없이 추가할 수 있는 표준 방법`이 생겼습니다.
