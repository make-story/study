# 서버사이드 데이터 호출 최적화

- 해당 데이터 이미지 Load 다른 비동기 데이터에 의한 이미지 Load 보다는 우선 순위. 네트워크 경쟁에세 우선이 됨.
- 서버사이드에서 데이터 호출이 추가되므로 First Contentful Paint (FCP) 시간이 약간 늘어날 수 있음
- 즉, 서버사이드 데이터 호출 + 캐시 프록시 형태로 구축필요

# 첫 화면 이미지 로드 최적화

22/08/09 배포전  
https://www.webpagetest.org/result/220809_BiDc6C_91G/

- FCP : 1.231 s
- LCP(Largest Contentful Paint) : 5.629S s
- CLS(Cumulative Layout Shift) : .086
- TBT(Total Blocking Time) : 2.342S s

22/08/10 배포후  
https://www.webpagetest.org/result/220810_BiDc78_46N/

- FCP : 2.532 s
- LCP(Largest Contentful Paint) : 2.532 s
- CLS(Cumulative Layout Shift) : 0
- TBT(Total Blocking Time) : 1.204 s

## 작업 내용

- 첫 화면 상단에 노출되는 컨텐츠, 사용자가 페이지 진입 후 바로 확인가능한 컨텐츠, 서버사이드 데이터 호출 (데이터 리스트 없을 때, 클라이언트 사이드에서 데이터 호출하는 방어로직 존재)
  - 서버사이드에서 API 호출이 추가되면서, 웹페이지가 사용자에게 전달되는 시간이 약간 증가 (Start Render, FCP)
- 레이지 로드 제거 (첫 화면 상단 사용자에게 바로 노출되는 컨텐츠이기 때문)
- 이미지 높이를 미리 잡고 있을 수 있도록, CSS 로 높이 설정 (Cumulative Layout Shift 향상)
  - https://wit.nts-corp.com/2020/12/28/6240
- loading ('eager' | 'lazy'), importance('auto' | 'low' | 'high') img 속성 활용 (웹 API)

---

# 시도

## 리소스

- Gif -> Video
  파일 포맷 변환 도구 개발 또는 도구 선정필요

- 이미지 썸네일 고도화  
  https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images

```html
<img
  srcset="elva-fairy-480w.jpg 480w, elva-fairy-800w.jpg 800w"
  sizes="(max-width: 600px) 480px,
         800px"
  src="elva-fairy-800w.jpg"
  alt="Elva dressed as a fairy"
/>

<img
  srcset="elva-fairy-320w.jpg, elva-fairy-480w.jpg 1.5x, elva-fairy-640w.jpg 2x"
  src="elva-fairy-640w.jpg"
  alt="Elva dressed as a fairy"
/>
```

```html
<picture>
  <source media="(max-width: 799px)" srcset="elva-480w-close-portrait.jpg" />
  <source media="(min-width: 800px)" srcset="elva-800w.jpg" />
  <img src="elva-800w.jpg" alt="Chris standing up holding his daughter Elva" />
</picture>

<picture>
  <source type="image/svg+xml" srcset="pyramid.svg" />
  <source type="image/webp" srcset="pyramid.webp" />
  <img src="pyramid.png" alt="regular pyramid built from four equilateral triangles" />
</picture>
```

과거 브라우저 대응

```html
<style>
  .pc {
  }
  .mobile {
    display: none;
  }
  @media (max-width: 767px) {
    .pc {
      display: none;
    }
    .mobile {
      display: inline;
    }
  }
</style>

<div>
  <img src="https://i.imgur.com/PQNhCln.gif" class="pc" />
  <img src="https://i.imgur.com/YrkG5xB.gif" class="mobile" />
</div>
```

- Next.js dynamic import
https://web.dev/code-splitting-with-dynamic-imports-in-nextjs/  
```javascript
import dynamic from "next/dynamic";

// 리액트 콤포넌트 동적 로드
// dynamic 호출되는 시점에, 해당 컴포넌트 코드가 포함된 청크파일 로드
const Puppy = dynamic(() => import("../components/Puppy"), {
  loading: () => <p>Loading...</p>
});
```

클라이언트 측에서만 구성요소를 렌더링 해야하는 경우
```javascript
const Puppy = dynamic(() => import("../components/Puppy"), {
  ssr: false,
});
```

## 도구

- 트리쉐이킹
https://webpack.kr/guides/tree-shaking/   

## 코드

- 다이나믹 임포트

## 캐시

- 서비스 워커 캐시 전략

- Next.js 반환된 동적 페이지 정적파일로 캐싱
