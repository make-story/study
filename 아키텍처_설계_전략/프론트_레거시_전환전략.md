

# 레거시 시스템 전환 전략
https://d2.naver.com/helloworld/2177909

모바일 블로그 페이지 전체를 한꺼번에 Node.js 환경으로 변경해 오픈하는 방법은 개발 기간이 오래 걸릴 뿐만 아니라 리스크 관리 측면에서도 꽤나 위험한 방식이다. 
특히나 블로그와 같이 대한민국의 거의 모든 사람들이 24시간 보고 즐기는 서비스라면 더욱 그렇다.

따라서 우리는 점진적으로 오픈하고 점진적으로 확인하고 점진적으로 경험을 쌓는 방식으로 접근해야만 했다. 
점진적으로 배포하기 위한 방법으로 고민했던 전략은 바로 `URL 단위의 배포`이다.  

# Reverse Proxy
블로그는 URL 단위 배포를 위해서 reverse proxy 구조를 채택했다.

이 구조는 사용자의 요청이 프록시 서버를 통해 웹 서버에 전달되고 웹 서버가 처리한 응답이 다시 프록시 서버를 통해 클라이언트로 전달된다.

reverse proxy는 주로 내부 네트워크와 외부 네트워크 사이를 분리해 보안 이슈를 해결하기 위해 사용되지만 블로그에서는 점진적인 URL 단위 배포를 위해 이를 이용했다. 
백엔드 개발자분들이 reverse proxy 구조를 구성해 주셨고 이를 바탕으로 URL 단위의 전환을 진행했다.

사용자가 m.blog.naver.com/페이지로 접근 시   
reverse proxy에서 Node.js SSR 전환이 완료된 페이지의 경우에는 Node.js SSR을 서빙하고   
그렇지 않은 페이지의 경우 기존 블로그 페이지를 서빙한다.  

# URL 단위 전환을 위한 준비
사이드 메뉴와 메인 메뉴는 별도의 URL이 존재하지 않기 때문에 선작업이 되어야 한다.  
공통 영역이 준비되면 URL 단위의 페이지 개발이 가능하다.  

# 기술 스택 검토
1. 사전에 문제를 빠르게 인지하고 검증할 수 있는가?
2. 문제 발생 시 어떻게 하면 쉽고 효과적으로 해결할 수 있는가?
3. 다양한 상황에 대해 충분한 검증이 이루어졌는가?
네이버 블로그 안정성, 투명성 관점에서 보다 우위에 있는 기술 스택을 선정

Node.js 
https://medium.com/@amragaey/shortly-how-node-js-works-on-a-single-thread-763fda99f012

# 성능 테스트
성능 테스트를 하는 목적은 크게 두 가지이다.
첫째, 애플리케이션과 서버 환경의 `최적의 환경을 찾는 것`.
둘째, 최적의 환경에서 어느 정도의 부하를 견뎌낼 수 있는지를 검증하고 인지하는 것. 즉, `시스템의 가용량을 확인`하는 것이다.  

`Node.js는 조회성 서비스를 주로 처리하기 때문에 TPS 단위보다는 페이지 하나의 요청 처리 수를 단위 시간으로 나눈 RPS(Request Per Second)로 표현하는 게 더 적합`  

## 가용성(Availability)이란 
서버와 네트워크, 프로그램 등의 정보 시스템이 정상적으로 사용 가능한 정도를 말한다. 시스템 가동률과 비슷한 의미이다.
시스템이 서비스를 정상적으로 제공할 수 있는 상태. 항상 서비스할 수 있는 시스템을 가용성이 높은 시스템이라고 한다.

`서비스가 다운되지 않고 정상적으로 유지된 시간`
uptime(정상 서비스 시간) / uptime + downtime(총 서비스 시간) = 가용성
가용성으로 나올수 있는 값은 0~1 사이 숫자 (소수자리 포함)
높을수록 가용성이 높다는 의미
주로 백분율화 하여 * 100 을 하여 표기함, ex) 99.5%, 100% 이런식으로 표현함

1년을 기준으로 계산하는게 보다 정확한 계산이 될 것
> uptime + downtime (총 서비스 시간)  
1시간 = 60분  
1일 = 24시간 = 1440분  
1달 = 30일 = 43200분  
1년 = 12달 = 518400분  

1년 동안 서비스장애 누적시간 60분, 작업시간으로 인한 서비스 단절 30분 = 총 90분
> uptime (서비스가 정상적으로 동작한 시간)  
518400 – 90 = 518310분  

가용성 계산
518310 / 518400 = 0.999826389  
0.999826389 * 100 = 99.982638889  
가용성 = 99.982638889 % 

# 에러 대응
Node.js의 경우 비동기 코드 중심의 개발이기 때문에 코드의 구현보다는 코드의 안정성을 확보하는 것이 보다 더 중요한 과업이다. 
Node.js의 경우에는 비동기 상황 시 발생하는 에러의 경우 UncaughtException이 발생하고 이로 인해 Node.js 프로세스가 죽는 경우도 발생한다.  

단순히 UncaughtException에 대한 에러 처리만으로는 궁극적으로 이 문제를 해결할 수 없다. 
Node.js 공식 문서에서도 UncaughtException이 발생한 경우 에러를 복구하는 것보다는 Node.js 인스턴스 자체를 재시작하기를 권장한다. 
https://nodejs.org/api/process.html#process_warning_using_uncaughtexception_correctly
궁극적으로는 애플리케이션 레벨에서 UncaughtException이 발생하지 않게 하는 것이 가장 좋은 해법이다.

# 롤백 플랜
Node.js SSR의 장점은 SSR 구조이지만 초기 진입 부분만 변경하면 CSR 형태의 서비스도 손쉽게 제공할 수 있다는 것이다.  
이를 이용하면 다음과 같은 단계적 롤백 플랜을 세울 수 있다.  

1. 사용자 부하를 받지 못하거나 장애가 발생하는 경우 CSR 페이지를 노출한다.  
2. CSR 페이지가 장애가 발생한 경우 프런트엔드 전환 전 페이지를 노출한다.  