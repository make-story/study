# `프론트엔드 최적화` 정리

http://makestory.net/media/#/view/846  
https://black7375.tistory.com/72  
https://ui.toast.com/fe-guide/ko_PERFORMANCE  

https://developers.google.com/speed/docs/insights/rules  
https://web.dev/why-speed-matters/  
https://web.dev/fast/  
https://developer.mozilla.org/en-US/docs/Web/Performance   
https://developer.mozilla.org/en-US/docs/Learn/HTML/Howto/Author_fast-loading_HTML_pages   
https://developer.mozilla.org/en-US/docs/Mozilla/Performance   

https://www.smashingmagazine.com/2021/01/front-end-performance-2021-free-pdf-checklist/   

https://ui.toast.com/weekly-pick/ko_20191204   
https://meetup.toast.com/posts/110  
https://ui.toast.com/weekly-pick/ko_20160523   
https://ui.toast.com/weekly-pick/ko_20190725    

https://www.w3.org/wiki/JavaScript_best_practices  


-----

# 리소스
## 우선순위
- Preload  
웹폰트에 많이 사용  
```html
<link rel="preload" as="font" crossorigin="crossorigin" type="font/woff2" href="myfont.woff2">
```

- Prefetch  
```html
<link rel="prefetch" href="page-2.html">
```

- Precontent
Preconnect는 외부 도메인과 연결을 구축하기 때문에 많은 CPU 시간을 차지할 수 있으며 보안 연결의 경우 더 많은 시간을 차지 할 수 있다.
(Preconnect는 10초 이내에 해당 서버에게 요청할 자원이 없으면 끊어진다는 것)
```html
<link rel="preconnect" href="https://example.com">
```


## 로드 (Load)
- 레이지 로드 
https://web.dev/lazy-loading-images/  

Internet Explorer support
```javascript
document.addEventListener("DOMContentLoaded", function() {
  let lazyImages = [].slice.call(document.querySelectorAll("img.lazy"));
  let active = false;

  const lazyLoad = function() {
    if (active === false) {
      active = true;

      setTimeout(function() {
        lazyImages.forEach(function(lazyImage) {
          if ((lazyImage.getBoundingClientRect().top <= window.innerHeight && lazyImage.getBoundingClientRect().bottom >= 0) && getComputedStyle(lazyImage).display !== "none") {
            lazyImage.src = lazyImage.dataset.src;
            lazyImage.srcset = lazyImage.dataset.srcset;
            lazyImage.classList.remove("lazy");

            lazyImages = lazyImages.filter(function(image) {
              return image !== lazyImage;
            });

            if (lazyImages.length === 0) {
              document.removeEventListener("scroll", lazyLoad);
              window.removeEventListener("resize", lazyLoad);
              window.removeEventListener("orientationchange", lazyLoad);
            }
          }
        });

        active = false;
      }, 200);
    }
  };

  document.addEventListener("scroll", lazyLoad);
  window.addEventListener("resize", lazyLoad);
  window.addEventListener("orientationchange", lazyLoad);
});
```

IntersectionObserver  
```html
<img class="lazy" src="placeholder-image.jpg" data-src="image-to-lazy-load-1x.jpg" data-srcset="image-to-lazy-load-2x.jpg 2x, image-to-lazy-load-1x.jpg 1x" alt="I'm an image!">
```
```javascript
document.addEventListener("DOMContentLoaded", function() {
    const lazyImages = [].slice.call(document.querySelectorAll("img.lazy"));

    if("IntersectionObserver" in window) {
        let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
            entries.forEach(function(entry) {
                if(entry.isIntersecting) {
                    let lazyImage = entry.target;
                    lazyImage.src = lazyImage.dataset.src;
                    lazyImage.srcset = lazyImage.dataset.srcset;
                    lazyImage.classList.remove("lazy");
                    lazyImageObserver.unobserve(lazyImage);
                }
            });
        });

        lazyImages.forEach(function(lazyImage) {
            lazyImageObserver.observe(lazyImage);
        });
    }else {
        
    }
});
```

- 크롬 네이티브 레이지 로드  
https://web.dev/browser-level-image-lazy-loading/
  
```html
<img data-src="img.jpg" loading="lazy" /> 
```
```javascript
if('loading' in HTMLImageElement.prototype) {
    alert("네이티브 레이지 로딩 지원함"); 
}else {
    alert("지원 안함");
}
```

- 비디오 영역 로드
https://web.dev/fast-playback-with-preload/  
```javascript
document.addEventListener("DOMContentLoaded", function() {
  let lazyVideos = [].slice.call(document.querySelectorAll("video.lazy"));

  if ("IntersectionObserver" in window) {
    let lazyVideoObserver = new IntersectionObserver(function(entries, observer) {
      entries.forEach(function(video) {
        if (video.isIntersecting) {
          for (let source in video.target.children) {
            let videoSource = video.target.children[source];
            if (typeof videoSource.tagName === "string" && videoSource.tagName === "SOURCE") {
              videoSource.src = videoSource.dataset.src;
            }
          }

          video.target.load();
          video.target.classList.remove("lazy");
          lazyVideoObserver.unobserve(video.target);
        }
      });
    });

    lazyVideos.forEach(function(lazyVideo) {
      lazyVideoObserver.observe(lazyVideo);
    });
  }
});
```
마진을 주면 스크롤 전에 로드를 시작하여 로드가 느려보이는 점을 보완
```javascript
let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
  // Lazy loading image code goes here
}, {
  rootMargin: "0px 0px 256px 0px"
});
```

## 컨텐츠 페이징(API)  

## 브라우저 동작기반
https://support.smartbear.com/alertsite/docs/monitors/metrics/web-page-load-time.html

## 브라우저 캐시 (Cache-Control)
no-store: 캐시하지 않고, 항상 다시 다운로드  
no-cache: 캐시하지만, 재검증을 위한 요청  
must-revalidate: 만료된 캐시만 재검증  
public | private: public은 프록시에 저장을 허용하고, private는 브라우저에만 저장을 허용  
max-age=< second >: 리소스가 유효하다고 판단하는 최대시간을 명시, 0이면 no-cache와 같음  

## 웹워커
https://bitsofco.de/web-workers-vs-service-workers-vs-worklets/  
https://www.twilio.com/blog/optimize-javascript-application-performance-web-workers

## 서비스워커
https://medium.com/@koh.yesl/progressive-web-app-libaries-in-production-991da49cc97  
https://medium.com/@onejohi/service-workers-in-depth-f5c9993ab8e7  
https://developers.google.com/web/fundamentals/architecture/app-shell?hl=ko  

## Worklet
Worker의 초기 비용이 큰 문제를 해결하기 위한 경량버전, 저수준 렌더링 파이프 라인에 접근가능  
https://developer.mozilla.org/en-US/docs/Web/API/Worklet  


## 폰트(Font) 포맷 
웹폰트 포맷에는 eot(IE 전용), ttf, woff2, woff, svg가 있다.  
eot와 ttf는 gzip과 같은 압축을 설정해야 한다.
Zopfli 압축을 통해 eot, ttf, woff를 5%정도 더 압축 가능
woff2의 압축률이 가장 높다(30% 이상) - https://www.w3.org/TR/WOFF20ER/

## 폰트(Font) 렌더링 방식
FOIT(Flash Of Invisible Text): 텍스트가 보이지 않은 상태(invisible)에서 지정된 폰트로 바뀌며 번쩍임 (크롬, 파이어폭스)  
FOUT(Flash Of Unstyled Text): Fallback 폰트(unstyled)에서 지정된 폰트로 바뀌며 번쩍임 (IE)  
컨텐츠를 먼저 보여는 FOUT 방식이 UX에 좋다.  

- font-display  
https://developer.mozilla.org/en-US/docs/Web/CSS/@font-face/font-display
auto: block과 비슷  
block: FOIT처럼 작동, 로딩되지 않을 때는 텍스트를 렌더링하지 않으며(최대 3초) 웹폰트가 로딩되면 적용  
swap: FOUT처럼 작동, 우선 Fallback으로 렌더링하고 웹폰트가 로딩되면 적용  
fallback: 100ms 동안 렌더링하지 않다가 Fallback으로 렌더링, 3초안에 로딩이 완료되면 완료된 폰트로 아니라면 Fallback 폰트 유지  
optional: 100ms 동안 렌더링 하지 않다가 Fallback으로 렌더링, 브라우저가 네트워크 상태를 파악해 웹폰트로 전환여부를 결정   


## 이미지 (WebP)  
https://github.com/Intervox/node-webp  
https://github.com/imagemin/imagemin  

## Gif -> Video 
https://medium.com/vingle-tech-blog/stop-using-gif-as-animation-3c6d223fd35a  
https://github.com/fluent-ffmpeg/node-fluent-ffmpeg



-----

# 코드
## DOM size  
https://web.dev/dom-size/  


## 자바스크립트 최적화

## 자바스크립트 캐시

## DocumentFragment  
https://davidwalsh.name/documentfragment  
```javascript
function batch(elements) {
  // First write
  const fragment = document.createFragment();
  elements.forEach(el => {
    fragment.appendChild(el);
  });
  this.parentElement.appendChild(fragment);
  
  // Then read
  elements.forEach(el => {
    el.getBoundingClientRect();
  });
}
```

## 이벤트 위임(Event Delegation)

## touch 이벤트
touchstart - touchmove - touchend - mouseover - mousemove - mousedown - mouseup - click  
https://developer.mozilla.org/en-US/docs/Web/API/Touch_events/Supporting_both_TouchEvent_and_MouseEvent   
https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariWebContent/HandlingEvents/HandlingEvents.html    
https://developers.google.com/web/fundamentals/design-and-ux/input/touch?hl=ko   

## requestAnimationFrame(), requestIdleCallback() 
https://medium.com/@codesquad_yoda/%EB%82%A8%EB%8B%A4%EB%A5%B8-%EA%B0%9C%EC%84%A0%EB%B0%A9%EB%B2%95%EC%9D%84-%EB%8B%A4%EC%8B%9C-%EB%B3%B4%EC%97%AC%EC%A4%80-%ED%8E%98%EC%9D%B4%EC%8A%A4%EB%B6%81%EC%9D%98-react-fiber-80b7ca5bd9bb    

## 레이아웃, 리플로우, 리페인트

## GPU, 하드웨어 가속
하드웨어 가속은 Graphics Layer 단위로 처리되며, GPU를 이용해 이미지로 합성(Composition)해 화면에 출력  
https://developer.mozilla.org/en-US/docs/Web/Performance/Animation_performance_and_frame_rate   

## Flexbox, Grid 
https://developer.mozilla.org/ko/docs/Learn/CSS/CSS_layout/Flexbox  
https://developer.mozilla.org/ko/docs/Web/CSS/CSS_Flexible_Box_Layout  

https://developer.mozilla.org/ko/docs/Learn/CSS/CSS_layout/Grids  
https://developer.mozilla.org/ko/docs/Web/CSS/CSS_Grid_Layout   

## Contain 속성
https://developer.mozilla.org/en-US/docs/Web/CSS/contain   
https://wit.nts-corp.com/2019/07/08/5594   

## HTML, JavaScript, CSS 공백, 줄 바꿈, 주석 등 불필요 코드 제거

## 웹컴포넌트
https://www.smashingmagazine.com/2016/12/styling-web-components-using-a-shared-style-sheet/   
- Custom elements  
- Shadow DOM  
- HTML Template  
- import  

## for, foreach, filter, map, reduce 성능
https://daesuni.github.io/Loop-performance/   
클 때: While  
작을 때: For of  
네이티브가 빠름  
For in은 상당히 느림  

Object.keys > for in > Object.getOwnPropertyNames, Object.values, Object.entries 순   
https://gists.cwidanage.com/2018/06/how-to-iterate-over-object-entries-in.html   


-----

# 도구
## 웹팩
- 트리쉐이킹  
실제 사용하는 의존성만 포함하는 기능   
```javascript
// 선택적 import 사용 권장
import array from 'lodash/array';
import object from 'lodash/fp/object';

// array(...);
// object(...);
```

## 리액트 


-----

# 인프라 / 네트워크 / 서버
## 인프라 아키텍처

## CDN  

## 스케일링

## 클러스터링

## MySQL 최적화

## 인메모리 캐시

## 태스크 큐


